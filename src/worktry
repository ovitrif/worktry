#!/bin/bash

show_help() {
  cat << EOF
worktry - Companion tool for worktree cli (wt)

USAGE:
  worktry init              Initialize repo for wt setup
  worktry new <name> [base] Create worktree directly (legacy)
  worktry -h, --help        Show this help message

FILES CREATED BY \`worktry init\`:
  worktrees.json            Config for wt setup command
  .worktree-setup.sh        Setup script (creates .claude/settings.local.json)
  .worktreekeep             List of files to copy to new worktrees (optional)

WORKFLOW:
  1. worktry init           # Initialize repo
  2. Edit .worktreekeep     # Add files to copy (e.g., .env, .idea/)
  3. wt setup feature -c    # Create worktree with setup

See: https://github.com/johnlindquist/worktree-cli
EOF
}

create_worktrees_json() {
  if [ -f "worktrees.json" ]; then
    echo "Error: worktrees.json already exists in current directory."
    echo "Remove it first or edit manually."
    exit 1
  fi

  # Create .worktreekeep template
  cat > .worktreekeep << 'KEEP_EOF'
# Files/directories to copy to new worktrees
# (one path per line, relative to repo root)
#
# Examples:
# .env
# local.properties
# .idea/
# keystore.properties
KEEP_EOF

  # Create setup script
  cat > .worktree-setup.sh << 'SETUP_EOF'
#!/bin/bash

# Create Claude Code settings
mkdir -p .claude
cat > .claude/settings.local.json << 'JSON_EOF'
{
  "permissions": {
    "allow": [
      "Bash",
      "Read",
      "Edit",
      "Write",
      "WebFetch",
      "mcp__ide__getDiagnostics",
      "WebSearch",
      "mcp__github__pull_request_read",
      "mcp__github__search_pull_requests",
      "mcp__github__list_pull_requests"
    ],
    "deny": [],
    "ask": [
      "Bash(rm -rf:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)"
    ],
    "additionalDirectories": [
      "/Users/ovitrif/repos"
    ]
  }
}
JSON_EOF

# Copy files listed in .worktreekeep
if [ -f "$ROOT_WORKTREE_PATH/.worktreekeep" ]; then
  while IFS= read -r line || [ -n "$line" ]; do
    # Skip comments and empty lines
    [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
    # Trim whitespace
    line=$(echo "$line" | xargs)
    src="$ROOT_WORKTREE_PATH/$line"
    if [ -e "$src" ]; then
      # Create parent directory if needed
      mkdir -p "$(dirname "$line")"
      cp -r "$src" "$line"
      echo "  Copied: $line"
    fi
  done < "$ROOT_WORKTREE_PATH/.worktreekeep"
fi
SETUP_EOF
  chmod +x .worktree-setup.sh

  # Create worktrees.json
  cat > worktrees.json << 'EOF'
{
  "setup-worktree": [
    "bash $ROOT_WORKTREE_PATH/.worktree-setup.sh"
  ]
}
EOF

  echo "âœ“ Created worktrees.json, .worktree-setup.sh, and .worktreekeep"
  echo ""
  echo "Next steps:"
  echo "  1. Edit .worktreekeep to add files to copy (e.g., .env, .idea/)"
  echo "  2. wt setup <branch-name> -c    # Create worktree with setup"
}

create_worktree() {
  NAME=$1
  BASE_BRANCH=${2:-HEAD}

  if [ -z "$NAME" ]; then
    echo "Error: Name argument is required."
    echo "Usage: worktry new <NAME> [BASE_BRANCH]"
    exit 1
  fi

  PROJECT_NAME=$(basename "$PWD")
  TARGET_PATH="../${PROJECT_NAME}.${NAME}"

  echo "Creating worktree '$NAME' at '$TARGET_PATH' from '$BASE_BRANCH'..."
  git worktree add "$TARGET_PATH" -b "$NAME" "$BASE_BRANCH"
}

case "$1" in
  init)
    create_worktrees_json
    ;;
  new)
    create_worktree "$2" "$3"
    ;;
  -h|--help|"")
    show_help
    ;;
  *)
    echo "Error: Unknown command '$1'"
    echo ""
    show_help
    exit 1
    ;;
esac
